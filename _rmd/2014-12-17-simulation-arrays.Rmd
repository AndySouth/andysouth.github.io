---
layout: post
title: Spatial, age and sex structured population simulation in R with arrays
author: Andy South
published: false
status: process
draft: true
tags: R 
---

In this post I'll outline why and how I use arrays as the main data structure in a population simulation which represents the age, sex and spatial location of tsetse flies. An earlier post outlines the background to this [tsetse population simulation]({% post_url 2014-12-12-rtsetse-intro %}).


I wanted a data structure that would make it easy and transparent for me to access elements with minimal code. I considered data frames, matrices and lists but opted for arrays. Hadley Wickham's excellent [Advanced R Data Structures](http://adv-r.had.co.nz/Data-structures.html) section was very helpful.

### Arrays
An `array` in R is a multi-dimensional object, and a `matrix` is a special case of an `array` with just 2 dimensions. The code below shows how you can use the `dim` argument to the `array` function to set up the number of dimensions.


```{r, eval=TRUE, echo=TRUE}
array(c(1:24), dim=c(4,3,2))
```

### Array dimensions
You can use the `dimnames` argument to name both the elements within each dimension and the dimension itself. One way of doing this is to set `dimnames` to a named list. I wanted to reduce the chance of creating bugs by accessing elements by name rather than position where possible. The code below shows how I create an array with spatial, sex and age dimensions.


```{r, eval=TRUE, echo=TRUE}
nY <- 4
nX <- 3
iMaxAge <- 2
sex <- c("F","M")
dimnames1 <- list( y=paste0('y',1:nY), x=paste0('x',1:nX), sex=sex, age=paste0('age',1:iMaxAge))
nElements <-  nY*nX*iMaxAge*length(sex)
aGrid <- array(1:nElements, dim=c(nY,nX,2,iMaxAge), dimnames=dimnames1)
aGrid
```

### Spatial dimension trickiness
I had to be careful specifying the spatial y & x dimensions as they do not always go in the order that you might expect (and your expectations may vary depending on whether your background is more geographical or statistical). By specifying y rather than x as the first dimension the array displays in the correct orientation with x on the horizontal and y on the vertical. Note that the y dimnsion elements start from the top which can cause geographical issues later.


### Accessing array dimensions
This array structure allows relatively transparent access to elements and summaries as shown below.

An age structure for one grid cell
```{r, eval=TRUE, echo=TRUE}
aGrid['y1','x1','M',] 
```

Total Males in one grid cell
```{r, eval=TRUE, echo=TRUE}
sum(aGrid['y1','x1','M',])
```

Total population in one grid cell
```{r, eval=TRUE, echo=TRUE}
sum(aGrid['y1','x1',,]) #
```

A spatial grid for one age
```{r, eval=TRUE, echo=TRUE}
aGrid[,,'M','age2']   
```

A spatial grid of total population
```{r, eval=TRUE, echo=TRUE}
apply(aGrid,MARGIN=c('y','x'),sum) 
```

Summed age structure for the whole population
```{r, eval=TRUE, echo=TRUE}
apply(aGrid,MARGIN=c('age'),sum) 
```

Summed sex ratio for thewhole population  
```{r, eval=TRUE, echo=TRUE}
apply(aGrid,MARGIN=c('sex'),sum) 
```

I have no written these array access statements into a helper function that I might describe later.

